# 詳細設計書

**プロジェクト名**: Gemini Vision Scanner
**バージョン**: 2.0.0
**作成日**: 2026-02-24

---

## 1. システムアーキテクチャ

### 1.1 全体構成

```
┌───────────────────────────────────────────────────┐
│          クライアント（ブラウザ）                      │
│  index.html + script.js + style.css                │
│  Vanilla JS / Material Design 3 Dark Theme         │
│  Webカメラ制御 / フレーム差分 / 画像ハッシュ / 結果描画 │
└──────────────────────┬────────────────────────────┘
                       │ HTTPS
┌──────────────────────▼────────────────────────────┐
│          nginx リバースプロキシ（Ubuntu）             │
│          HTTPS:8443 → localhost:8001               │
└──────────────────────┬────────────────────────────┘
                       │
┌──────────────────────▼────────────────────────────┐
│       gunicorn（WSGI サーバー, 2ワーカー）           │
│  ┌─────────────────────────────────────────────┐  │
│  │              app.py（Flask）                   │  │
│  │  ルーティング / バリデーション / セキュリティ     │  │
│  └────────┬──────────────────┬──────────────── ┘  │
│           │                  │                     │
│  ┌────────▼────────┐  ┌─────▼──────────┐         │
│  │  gemini_api.py  │  │ rate_limiter.py│         │
│  │  7モード解析     │  │ Redis/インメモリ │         │
│  └────────┬────────┘  └────────────────┘         │
└───────────┼───────────────────────────────────────┘
            │
┌───────────▼───────────────────────────────────────┐
│           Google Gemini API                        │
│  generativelanguage.googleapis.com/v1beta/models/  │
└───────────────────────────────────────────────────┘
```

### 1.2 モジュール依存関係

```
app.py
  ├── gemini_api.py
  │     └── translations.py
  └── rate_limiter.py
        ├── redis（オプション）
        └── cachetools（フォールバック）
```

---

## 2. リクエスト処理パイプライン

### POST /api/analyze のフロー

```
[1] before_request: set_request_context()
    ├── g.request_id = secrets.token_hex(8)    # 16文字の相関ID
    └── g.csp_nonce = secrets.token_urlsafe(16)

[2] _validate_analyze_request()
    ├── is_json チェック           → ERR_INVALID_FORMAT (400)
    ├── image フィールド存在チェック → ERR_MISSING_IMAGE (400)
    ├── mode バリデーション         → ERR_INVALID_MODE (400)
    ├── hint サニタイズ（制御文字除去・200文字上限）
    ├── data:image プレフィックス除去
    ├── base64.b64decode(validate=True) → ERR_INVALID_BASE64 (400)
    ├── サイズチェック（5MB以下）      → ERR_IMAGE_TOO_LARGE (400)
    └── マジックバイト検証（JPEG/PNG） → ERR_INVALID_IMAGE_FORMAT (400)

[3] _build_rate_key()
    ├── ip_ua: IP + SHA256(UserAgent[:64])[:8]
    └── ip: IPアドレスのみ

[4] try_consume_request(rate_key) — 予約方式
    ├── 日次制限超過 → 429 (limit_type=daily)
    └── 分制限超過   → 429 (limit_type=minute, retry_after=秒数)

[5] detect_content(image_data, mode, request_id, context_hint)
    ├── _ensure_jpeg（PNG→JPEG変換、text/labelはコントラスト強調）
    ├── _build_gemini_payload（プロンプト・JSONスキーマ・thinkingConfig）
    ├── _send_gemini_request（429リトライ含む）
    ├── _extract_gemini_content（candidates/parts/JSONパース）
    └── _dispatch_mode_handler（モード別パーサー呼び出し）

[6] 成功時: 200 JSONレスポンス
    失敗時: release_request(rate_key, request_id) でロールバック → 502

[7] after_request: add_security_headers()
    ├── CSP / X-Frame-Options / Referrer-Policy
    ├── Cache-Control
    ├── X-Request-Id
    └── CORS ヘッダー
```

---

## 3. APIエンドポイント仕様

### 3.1 一覧

| メソッド | パス | 認証 | 説明 |
|---|---|---|---|
| GET | `/` | なし | メインページHTML |
| GET | `/healthz` | なし | Livenessチェック |
| GET | `/readyz` | なし | Readinessチェック |
| GET | `/api/config/limits` | なし | 日次上限値取得 |
| GET | `/api/config/usage` | なし | IP別日次使用量取得 |
| GET | `/api/config/proxy` | なし/管理者 | プロキシ状態取得 |
| POST | `/api/config/proxy` | X-Admin-Secret | プロキシ有効/無効切替 |
| POST | `/api/analyze` | なし(レート制限) | 画像解析メイン |
| OPTIONS | `/api/analyze` | なし | CORSプリフライト(204) |

### 3.2 POST /api/analyze

**リクエスト**:
```json
{
  "image": "Base64文字列（data:image/...;base64, プレフィックス可）",
  "mode": "text|object|label|face|logo|classify|web",
  "hint": "追加コンテキスト（任意・最大200文字）"
}
```

**成功レスポンス (200)**:
```json
{
  "ok": true,
  "data": [{"label": "...", "bounds": [[x,y],...]}],
  "image_size": [width, height]
}
```

**レート制限レスポンス (429)**:
```json
{
  "ok": false,
  "error_code": "APP_RATE_LIMITED",
  "message": "...",
  "limit_type": "daily|minute",
  "retry_after": 10
}
```

### 3.3 エラーコード一覧

| エラーコード | HTTPステータス | 説明 |
|---|---|---|
| `INVALID_FORMAT` | 400 | JSON形式でない、またはパースエラー |
| `MISSING_IMAGE` | 400 | imageフィールドが空・null |
| `INVALID_MODE` | 400 | 不正なモード値 |
| `INVALID_BASE64` | 400 | Base64デコード失敗 |
| `IMAGE_TOO_LARGE` | 400 | デコード後5MB超 |
| `INVALID_IMAGE_FORMAT` | 400 | JPEG/PNG以外 |
| `REQUEST_TOO_LARGE` | 413 | リクエストボディ10MB超 |
| `APP_RATE_LIMITED` | 429 | アプリ側レート制限超過 |
| `UNAUTHORIZED` | 403 | 管理API認証失敗 |
| `SERVER_ERROR` | 500 | 予期しない例外 |
| `TIMEOUT` | 502 | Gemini APIタイムアウト |
| `CONNECTION_ERROR` | 502 | Gemini API接続失敗 |
| `GEMINI_RATE_LIMITED` | 429 | Gemini API側の429 |
| `SAFETY_BLOCKED` | 502 | 安全フィルターによるブロック |
| `PARSE_ERROR` | 502 | JSONパース失敗 |

---

## 4. セキュリティ設計

### 4.1 CSP nonce機構

```python
# before_request でリクエストごとに生成
g.csp_nonce = secrets.token_urlsafe(16)

# after_request でCSPヘッダーに付与
Content-Security-Policy:
  default-src 'self';
  script-src 'self' 'nonce-{nonce}';
  style-src 'self' 'nonce-{nonce}' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  img-src 'self' blob: data:;
  media-src 'self' blob: mediastream:;
  connect-src 'self'
```

### 4.2 管理者認証

```python
def _is_admin_authenticated() -> bool:
    if not ADMIN_SECRET:
        return False  # 未設定時は常に403
    auth_header = request.headers.get("X-Admin-Secret", "")
    return secrets.compare_digest(auth_header, ADMIN_SECRET)  # タイミング攻撃対策
```

### 4.3 画像フォーマット検証

| マジックバイト | フォーマット |
|---|---|
| `\xff\xd8\xff` | JPEG |
| `\x89PNG\r\n\x1a\n` | PNG |

### 4.4 CORS設計

- `ALLOWED_ORIGINS`未設定時: CORSヘッダーを一切付与しない（同一オリジンのみ）
- 設定時: 正確なOrigin一致のみ許可（ワイルドカード不可）
- `Vary: Origin`を付与してプロキシキャッシュの混在を防止

---

## 5. Thinking戦略（モデル別thinkingConfig）

```python
_THINKING_STRATEGY_TABLE = {
    ("gemini-2", "flash"): {"thinkingBudget": 0},       # 思考無効化（速度優先）
    ("gemini-2", "pro"):   {},                           # 無効化不可 → キーごと除外
    ("gemini-3", "flash"): {"thinkingLevel": "MINIMAL"}, # 最小思考
    ("gemini-3", "pro"):   {"thinkingLevel": "MINIMAL"}, # 最小思考
}
```

- 空辞書の場合は`generationConfig`から`thinkingConfig`キーごと除外（APIデフォルトに委任）
- 未知モデルは空辞書を返し安全側に動作
- 初回のみ未知モデル警告ログを出力（重複抑制: `_warned_unknown_model` set）

---

## 6. 画像前処理設計

### 6.1 _ensure_jpeg() の処理フロー

```
入力: Base64文字列
  ├── base64.b64decode
  ├── Image.open（PIL）
  ├── サイズチェック: width × height > MAX_IMAGE_PIXELS(2000万) → ValueError
  ├── モード変換: RGBA/CMYK → RGB
  ├── enhance=True の場合（text/labelモード）:
  │     ├── ImageEnhance.Contrast(1.5)
  │     └── ImageEnhance.Sharpness(1.5)
  ├── img.save(buffer, format="JPEG", quality=95)
  └── base64.b64encode → 出力
```

### 6.2 バウンディングボックス座標系

Gemini APIが返す`box_2d`は`[ymin, xmin, ymax, xmax]`形式で0〜1000スケール。

| 変換先 | 関数 | 用途 |
|---|---|---|
| ピクセル座標 | `_gemini_box_to_pixel_vertices(box_2d, w, h)` | text・face・logo・labelモード |
| 正規化座標(0-1) | `_gemini_box_to_normalized_vertices(box_2d)` | objectモード |

反転ボックス(ymin > ymax等)は`_sanitize_box_2d()`で自動修正。値は0〜1000にクランプ。

---

## 7. エラーハンドリング戦略

| レイヤー | 戦略 |
|---|---|
| app.py | ValueErrorはVALIDATION_ERROR(400)、その他はSERVER_ERROR(500)。`logger.exception()`でスタックトレース出力。失敗時は必ず`release_request()`でロールバック |
| gemini_api.py | Timeout→TIMEOUT、ConnectionError→CONNECTION_ERROR、RequestException→REQUEST_ERROR。`_ensure_jpeg`のValueErrorは伝播 |
| rate_limiter.py | Redis接続失敗時はインメモリにフォールバック。ログに警告出力 |
| script.js | AbortError(タイムアウト)は再試行しない。`_retriesExhausted`フラグで「再試行失敗」を区別。連続スキャン中は`scheduleRetry()`で自動復帰 |

---

## 8. デプロイ構成

### 8.1 Ubuntu構成

```
nginx (HTTPS:8443)
  ├── SSL: 自己署名証明書 (/etc/nginx/ssl/)
  ├── 静的ファイル: /opt/gemini-scanner/static/ を直接配信
  └── リバースプロキシ → gunicorn (localhost:8001)

gunicorn (2ワーカー, timeout=60s)
  └── Flask app (/opt/gemini-scanner/)
        ├── .env (chmod 600)
        └── venv/

systemd: gemini-scanner.service
  ├── Restart=on-failure, RestartSec=5
  └── EnvironmentFile=/opt/gemini-scanner/.env
```

### 8.2 Render構成

```
Build Command: pip install -r requirements.txt
Start Command: gunicorn app:app --bind 0.0.0.0:$PORT --workers 2 --timeout 60
Python: 3.12.0
環境変数: Renderダッシュボードで管理
```

### 8.3 Vision AI Scannerとの共存

| アプリ | nginxポート | gunicornポート |
|--------|-----------|---------------|
| Vision AI Scanner | 443 | 8000 |
| Gemini Vision Scanner | 8443 | 8001 |

---

## 9. テスト戦略

### 9.1 テスト構成

| ファイル | テスト対象 |
|---|---|
| `tests/conftest.py` | 共有フィクスチャ・ヘルパー関数 |
| `tests/test_api.py` | Flask APIエンドポイント統合テスト |
| `tests/test_gemini_api.py` | gemini_api.py単体テスト（リトライ・パーサー・エラー処理） |
| `tests/e2e/` | Playwright E2Eテスト（`@pytest.mark.e2e`で分離） |

### 9.2 テスト実行コマンド

```bash
python -m pytest tests/ -q -m "not e2e"       # E2E除外（通常使用）
python -m pytest tests/test_api.py -q          # Flask API統合テストのみ
python -m pytest tests/test_gemini_api.py -q   # Gemini API単体テストのみ
```

### 9.3 テストヘルパー

- `create_valid_image_base64()`: JPEG画像のBase64文字列を生成
- `create_valid_png_base64()`: PIL生成PNG画像のBase64文字列を生成
- `make_mock_response(status_code, json_data, content_type)`: レスポンスモック
- `make_gemini_response(candidates)`: Gemini APIレスポンスモック
- `reset_for_testing()`: レート制限をインメモリにリセット
