# プログラム詳細設計書

**プロジェクト名**: Gemini Vision Scanner
**バージョン**: 2.0.0
**作成日**: 2026-02-24

---

## 1. モジュール構成

```
gemini-vision処理/
├── app.py              → メインアプリケーション（Flask）
├── gemini_api.py       → Gemini API連携モジュール
├── rate_limiter.py     → レート制限モジュール
├── translations.py     → 翻訳辞書モジュール
├── templates/
│   └── index.html      → メインHTMLテンプレート
├── static/
│   ├── script.js       → フロントエンドロジック
│   └── style.css       → スタイルシート
└── tests/
    ├── conftest.py     → テスト共通フィクスチャ
    ├── test_api.py     → Flask API統合テスト
    └── test_gemini_api.py → Gemini API単体テスト
```

---

## 2. app.py — メインアプリケーション

### 2.1 定数

| 定数名 | 型 | デフォルト値 | 説明 |
|--------|-----|-------------|------|
| `APP_VERSION` | str | `"2.0.0"` | テンプレートに注入されるバージョン |
| `MAX_IMAGE_SIZE` | int | `5,242,880` | Base64デコード後の画像サイズ上限（5MB） |
| `MAX_REQUEST_BODY` | int | `10,485,760` | リクエストボディ上限（10MB） |
| `ADMIN_SECRET` | str | 環境変数 | 管理API認証用シークレット |
| `RATE_LIMIT_KEY_MODE` | str | `"ip"` | レート制限キー方式（`ip` or `ip_ua`） |
| `ALLOWED_ORIGINS` | list[str] | `[]` | CORS許可Origin一覧 |
| `ALLOWED_IMAGE_MAGIC` | dict | JPEG/PNG | 許可するマジックバイト辞書 |

### 2.2 エラーコード定数

| 定数名 | 値 | HTTP | 説明 |
|--------|-----|------|------|
| `ERR_INVALID_FORMAT` | `"INVALID_FORMAT"` | 400 | JSON形式でない |
| `ERR_MISSING_IMAGE` | `"MISSING_IMAGE"` | 400 | imageフィールド欠落 |
| `ERR_INVALID_MODE` | `"INVALID_MODE"` | 400 | 不正なモード値 |
| `ERR_INVALID_BASE64` | `"INVALID_BASE64"` | 400 | Base64デコード失敗 |
| `ERR_IMAGE_TOO_LARGE` | `"IMAGE_TOO_LARGE"` | 400 | デコード後5MB超 |
| `ERR_INVALID_IMAGE_FORMAT` | `"INVALID_IMAGE_FORMAT"` | 400 | JPEG/PNG以外 |
| `ERR_RATE_LIMITED` | `"APP_RATE_LIMITED"` | 429 | アプリ側レート制限超過 |
| `ERR_REQUEST_TOO_LARGE` | `"REQUEST_TOO_LARGE"` | 413 | リクエストボディ10MB超 |
| `ERR_SERVER_ERROR` | `"SERVER_ERROR"` | 500 | 予期しない例外 |
| `ERR_UNAUTHORIZED` | `"UNAUTHORIZED"` | 403 | 管理API認証失敗 |

### 2.3 関数一覧

#### `_check_admin_secret(secret: str) -> list[str]`

ADMIN_SECRETの強度を検証する。

| 項目 | 内容 |
|------|------|
| 引数 | `secret`: 検証対象のシークレット文字列 |
| 戻り値 | 警告メッセージのリスト（問題なければ空リスト） |
| 検証項目 | 未設定チェック、長さ16文字以上、文字種3種以上（大文字/小文字/数字/記号） |
| 呼び出し元 | モジュール初期化時（起動時に1回） |

#### `_static_file_hash(filename: str) -> str`

静的ファイルのMD5ハッシュ先頭8文字を返す（キャッシュバスティング用）。

| 項目 | 内容 |
|------|------|
| 引数 | `filename`: staticディレクトリ内のファイル名 |
| 戻り値 | MD5ハッシュ先頭8文字（OSError時は`"0"`） |
| キャッシュ | `_static_hash_cache`辞書。filename単位でキャッシュし、mtimeが変わったら上書き |
| 呼び出し元 | テンプレート内 `{{ static_hash('script.js') }}` |

#### `set_request_context() -> None`

`@app.before_request` フック。リクエストごとに一意のIDとCSPノンスを生成する。

| 項目 | 内容 |
|------|------|
| 生成値 | `g.request_id = secrets.token_hex(8)`（16文字の相関ID） |
| 生成値 | `g.csp_nonce = secrets.token_urlsafe(16)` |

#### `add_security_headers(response) -> Response`

`@app.after_request` フック。全レスポンスにセキュリティヘッダーを付与する。

| ヘッダー | 値 |
|----------|-----|
| `X-Content-Type-Options` | `nosniff` |
| `X-Frame-Options` | `DENY` |
| `Referrer-Policy` | `strict-origin-when-cross-origin` |
| `Content-Security-Policy` | nonce付きCSP（`unsafe-inline`排除） |
| `Permissions-Policy` | `camera=(self), microphone=(self)` |
| `Cache-Control` | 静的ファイル: `public, max-age=31536000, immutable` / API: `no-store` |
| `X-Request-Id` | リクエスト相関ID |
| CORS | `ALLOWED_ORIGINS`一致時のみ付与、`Vary: Origin`付き |

#### `_build_rate_key() -> tuple[str, str]`

リクエストのIP（+UserAgent）からレート制限キーを生成する。

| 項目 | 内容 |
|------|------|
| 戻り値 | `(client_ip, rate_key)` のタプル |
| `ip_ua`モード | `rate_key = "{IP}:{SHA256(UserAgent[:64])[:8]}"` |
| `ip`モード | `rate_key = "{IP}"` |

#### `_is_admin_authenticated() -> bool`

リクエストのX-Admin-Secretヘッダーで管理者認証を検証する。

| 項目 | 内容 |
|------|------|
| 戻り値 | `ADMIN_SECRET`設定済み かつ ヘッダー値が一致なら`True` |
| セキュリティ | `secrets.compare_digest()`でタイミング攻撃を防止 |

#### `_error_response(error_code, message, status_code, headers) -> tuple[Response, int]`

```python
def _error_response(
    error_code: str,
    message: str,
    status_code: int = 400,
    headers: dict[str, str] | None = None,
) -> tuple[Response, int]
```

標準化されたエラーレスポンスJSONを生成する。

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `ok` | bool | 常に`False` |
| `data` | list | 常に空リスト |
| `error_code` | str | エラーコード定数 |
| `message` | str | 日本語エラーメッセージ |

#### `_log(level: str, event: str, **kwargs) -> None`

構造化ログ出力。`g.request_id`を自動付与する。

```
出力例: event=api_success request_id=a1b2c3d4 ip=192.168.1.1 mode=text items=3
```

#### `_validate_image_format(decoded_bytes: bytes) -> bool`

デコード済みバイト列のマジックバイトを検査し、JPEG/PNGか判定する。

| マジックバイト | フォーマット |
|-------------|------------|
| `\xff\xd8\xff` | JPEG |
| `\x89PNG\r\n\x1a\n` | PNG |

#### `_validate_analyze_request() -> tuple[str|None, str|None, str|None, tuple|None]`

`POST /api/analyze` のリクエストを検証し、画像データ・モード・ヒントを返す。

```
検証フロー:
  [1] is_json チェック
  [2] JSON パース
  [3] dict型チェック
  [4] image フィールド存在・文字列チェック
  [5] mode バリデーション（isinstance(mode, str) + VALID_MODES）
  [6] hint サニタイズ（制御文字除去・200文字上限）
  [7] data:image プレフィックス除去
  [8] base64.b64decode(validate=True)
  [9] サイズチェック（5MB以下）
  [10] マジックバイト検証（JPEG/PNG）
```

| 戻り値パターン | 条件 |
|-------------|------|
| `(image_data, mode, hint, None)` | 検証成功 |
| `(None, None, None, error_response)` | 検証失敗 |

#### `analyze_endpoint() -> tuple[Response, int]`

`POST /api/analyze` のメインハンドラ。

```
処理フロー:
  [1] _validate_analyze_request() → バリデーション
  [2] _build_rate_key() → レート制限キー生成
  [3] try_consume_request(rate_key) → 予約方式チェック
  [4] detect_content(image_data, mode, ...) → Gemini API呼び出し
  [5] 成功: 200 JSON返却
  [6] API失敗: release_request() → ロールバック → 502
  [7] ValueError: release_request() → 400
  [8] Exception: release_request() → logger.exception() → 500
```

### 2.4 エンドポイント一覧

| メソッド | パス | 関数名 | 説明 |
|---------|------|--------|------|
| GET | `/` | `index()` | メインHTMLページ |
| GET | `/healthz` | `healthz()` | Livenessチェック |
| GET | `/readyz` | `readyz()` | Readinessチェック |
| GET | `/api/config/limits` | `get_rate_limits()` | 日次上限値取得 |
| GET | `/api/config/usage` | `get_usage()` | IP別日次使用量取得 |
| GET | `/api/config/proxy` | `get_proxy_config()` | プロキシ状態取得 |
| POST | `/api/config/proxy` | `update_proxy_config()` | プロキシ切替（認証必須） |
| OPTIONS | `/api/analyze` | `analyze_preflight()` | CORSプリフライト |
| POST | `/api/analyze` | `analyze_endpoint()` | 画像解析メイン |

---

## 3. gemini_api.py — Gemini API連携モジュール

### 3.1 定数

| 定数名 | 型 | デフォルト値 | 説明 |
|--------|-----|-------------|------|
| `API_KEY` | str | 環境変数必須 | Google Gemini APIキー |
| `GEMINI_MODEL` | str | `"gemini-2.5-flash"` | 使用モデル |
| `API_BASE_URL` | str | googleapis.com | APIエンドポイントベースURL |
| `VALID_MODES` | set | 7種 | 許可モード値の集合 |
| `API_TIMEOUT_SECONDS` | int | `30` | APIタイムアウト（秒） |
| `GEMINI_429_MAX_RETRIES` | int | `2` | 429リトライ回数 |
| `GEMINI_429_BACKOFF_BASE_SECONDS` | float | `1.5` | バックオフ基準秒 |
| `MAX_IMAGE_PIXELS` | int | `20,000,000` | 最大ピクセル数 |
| `CONTRAST_FACTOR` | float | `1.5` | コントラスト強調係数 |
| `SHARPNESS_FACTOR` | float | `1.5` | シャープネス強調係数 |
| `JPEG_QUALITY` | int | `95` | JPEG保存品質 |
| `BOX_SCALE` | int | `1000` | box_2d座標の正規化スケール |
| `GENERATION_TEMPERATURE` | float | `0.1` | 生成温度パラメータ |
| `SIGNIFICANT_EMOTION_LEVELS` | frozenset | 3種 | 感情表示閾値（POSSIBLE以上） |

### 3.2 System Instruction

全モード共通の制約をSystem Instructionとして定義。

```
_SYSTEM_INSTRUCTION:
  - box_2d は [ymin, xmin, ymax, xmax] 形式で 0〜1000 正規化
  - score/confidence は 0.0〜1.0
  - 該当データなし → 空配列
  - 日本語フィールドは自然な日本語
```

### 3.3 モードプロンプト（MODE_PROMPTS）

| モード | プロンプト概要 |
|--------|--------------|
| `text` | すべてのテキストブロックを検出し、内容とバウンディングボックスを返す |
| `object` | 最大10物体を検出、英語名/日本語名/スコア/box_2d |
| `label` | ラベル/バーコード/QRコードの有無を判定、テキスト内容も返す |
| `face` | 顔を検出、box_2d/confidence/4感情（5段階） |
| `logo` | ブランドロゴを検出、名前/スコア/box_2d |
| `classify` | 分類タグを最大10個、英語名/日本語名/スコア |
| `web` | best_guess/entities/description で識別結果を返す |

### 3.4 JSON Schema（MODE_SCHEMAS）

各モードのレスポンスを強制するGemini API用JSON Schema定義。

| モード | ルートキー | 必須フィールド |
|--------|----------|-------------|
| `text` | `texts[]` | `text`, `box_2d` |
| `object` | `objects[]` | `name`, `score`, `box_2d` |
| `label` | `label_detected`, `reason`, `texts[]` | `label_detected`, `reason` |
| `face` | `faces[]` | `box_2d`, `confidence`, `joy`, `sorrow`, `anger`, `surprise` |
| `logo` | `logos[]` | `name`, `score`, `box_2d` |
| `classify` | `labels[]` | `name`, `score` |
| `web` | `best_guess`, `entities[]` | `best_guess`, `entities` |

感情フィールドのenum制約: `["VERY_UNLIKELY", "UNLIKELY", "POSSIBLE", "LIKELY", "VERY_LIKELY"]`
score/confidenceのminimum/maximum制約: `0` 〜 `1`

### 3.5 Thinking戦略テーブル

```python
_THINKING_STRATEGY_TABLE = {
    ("gemini-2", "flash"): {"thinkingBudget": 0},       # 思考無効化（速度優先）
    ("gemini-2", "pro"):   {},                           # 除外（無効化不可）
    ("gemini-3", "flash"): {"thinkingLevel": "MINIMAL"}, # 最小思考
    ("gemini-3", "pro"):   {"thinkingLevel": "MINIMAL"}, # 最小思考
}
```

| ルール | 説明 |
|--------|------|
| 空辞書 | `generationConfig`から`thinkingConfig`キーごと除外 |
| 未知モデル | 空辞書を返す（安全側） |
| 警告抑制 | `_warned_unknown_model` setで重複ログを防止 |

### 3.6 関数一覧

#### `_resolve_thinking_config() -> dict`

モデル名に基づいてthinkingConfig辞書を返す。

```
判定ロジック:
  model.lower() が gen_prefix で始まり type_keyword を含む
  → 対応するconfigを返す
  マッチなし → 空辞書（初回のみ警告ログ）
```

#### `_make_success(data, image_size=None, **extra) -> dict`

成功レスポンス辞書を生成する。

```python
{"ok": True, "data": [...], "image_size": [w, h], "error_code": None, "message": None, ...extra}
```

#### `_make_error(error_code, message) -> dict`

失敗レスポンス辞書を生成する。

```python
{"ok": False, "data": [], "image_size": None, "error_code": "...", "message": "..."}
```

#### `_get_retry_after_seconds(response, fallback_seconds) -> float`

Retry-Afterヘッダーを秒に正規化して返す。不正値・負値・欠損時はフォールバック値を使用。

#### `get_proxy_status() -> dict`

現在のプロキシ設定状態を返す。URL内の認証情報は`_mask_proxy_url()`でマスク。

```python
{"enabled": bool, "url": "http://***:***@host:port"}
```

#### `set_proxy_enabled(enabled: bool) -> dict`

プロキシの有効/無効を切り替える（`_proxy_lock`でスレッド安全）。

```
処理:
  [1] Lock取得
  [2] NO_PROXY_MODE フラグ更新
  [3] session.proxies 更新
  [4] Lock解放
  [5] ログ出力
  [6] get_proxy_status() 返却
```

#### `_clamp(value, min_val, max_val) -> number`

値を`[min_val, max_val]`の範囲にクランプする。

#### `_sanitize_box_2d(box_2d) -> tuple | None`

box_2dを0〜BOX_SCALE範囲にクランプし、反転ボックス（ymin > ymax等）を修正する。

| 入力 | 出力 |
|------|------|
| `[800, 200, 100, 900]` | `(100, 200, 800, 900)` — ymin/ymax反転修正 |
| `[100, 200, 800, 900]` | `(100, 200, 800, 900)` — そのまま |
| `None` or 長さ≠4 | `None` |

#### `_gemini_box_to_pixel_vertices(box_2d, img_width, img_height) -> list`

Gemini box_2d（0〜1000スケール）をピクセル座標4頂点に変換する。

```
入力: [ymin, xmin, ymax, xmax] (0〜1000)
出力: [[x1,y1], [x2,y2], [x3,y3], [x4,y4]] (ピクセル座標、左上→右上→右下→左下)
変換式: px_x = int((x / 1000) * img_width)
```

#### `_gemini_box_to_normalized_vertices(box_2d) -> list`

Gemini box_2d（0〜1000スケール）を正規化座標（0〜1）4頂点に変換する。objectモード専用。

```
入力: [ymin, xmin, ymax, xmax] (0〜1000)
出力: [[x1,y1], [x2,y2], [x3,y3], [x4,y4]] (0.0〜1.0)
変換式: nx = x / 1000
```

#### `_resolve_pixel_bounds(box_2d, image_size) -> list`

box_2dとimage_sizeが有効な場合のみピクセル座標に変換する。どちらかが無効なら空リスト。

#### `_build_translated_label(en_name, ja_name, score, translations) -> str`

英語名に日本語訳を付加したラベル文字列を構築する。

```
出力例: "Person（人）- 95%"
フォールバック: ja_name → translations辞書 → 英語名のみ
```

#### `_open_image(image_b64) -> PIL.Image.Image`

Base64画像をデコードしてPIL Imageとして返す。ピクセル数がMAX_IMAGE_PIXELSを超える場合はValueError。

#### `_get_image_dimensions(image_b64) -> list | None`

Base64画像のピクセル寸法`[width, height]`を取得する。失敗時は`None`。

#### `_ensure_jpeg(image_b64, enhance=False) -> str`

画像をJPEG形式に統一変換する。

```
処理フロー:
  [1] base64.b64decode → PIL Image.open
  [2] ピクセル数チェック（MAX_IMAGE_PIXELS超 → ValueError）
  [3] RGBA/CMYK → RGB変換
  [4] enhance=True の場合:
      - ImageEnhance.Contrast(1.5)
      - ImageEnhance.Sharpness(1.5)
  [5] JPEG形式で保存（quality=95）
  [6] base64.b64encode → 文字列返却
```

| パラメータ | 条件 | 用途 |
|-----------|------|------|
| `enhance=True` | text, labelモード | コントラスト・シャープネス強調でOCR精度向上 |
| `enhance=False` | その他のモード | JPEG統一変換のみ |

#### `_build_gemini_payload(image_b64, mode, context_hint="") -> dict`

Gemini APIリクエスト用のペイロードを構築する。

```python
{
    "system_instruction": {"parts": [{"text": _SYSTEM_INSTRUCTION}]},
    "contents": [{
        "parts": [
            {"inlineData": {"mimeType": "image/jpeg", "data": image_b64}},
            {"text": prompt},  # MODE_PROMPTS[mode] + context_hint
        ]
    }],
    "generationConfig": {
        "responseMimeType": "application/json",
        "responseSchema": MODE_SCHEMAS[mode],
        "temperature": 0.1,
        "thinkingConfig": {...},  # 空辞書の場合はキーごと除外
    },
}
```

#### `_send_gemini_request(api_url, payload, request_id, mode) -> tuple`

Gemini APIにリクエストを送信し、429リトライを処理する。

```
リトライフロー:
  for attempt in range(MAX_RETRIES + 1):
    [1] session.post() → レスポンス取得
    [2] status ≠ 429 → ループ脱出
    [3] attempt ≥ MAX_RETRIES → GEMINI_RATE_LIMITED エラー返却
    [4] 待機秒数 = Retry-After ヘッダー or (base * 2^attempt + jitter)
    [5] time.sleep(wait)

  status ≠ 200 → API_{status} エラー返却
  response.json() 失敗 → PARSE_ERROR or API_RESPONSE_NOT_JSON
  成功 → (result_dict, None)
```

#### `_extract_gemini_content(api_result, request_id, mode) -> tuple`

Gemini APIレスポンスからコンテンツJSONを抽出する。

```
処理フロー:
  [1] candidates 配列チェック
      - 空 + blockReason → SAFETY_BLOCKED エラー
      - 空（理由なし） → 空データ成功
  [2] finishReason チェック
      - "SAFETY" → SAFETY_BLOCKED
      - "MAX_TOKENS" 等 → INCOMPLETE_RESPONSE
  [3] parts からテキスト結合
      - thought=True のパートは除外
      - text が無いパートは除外
  [4] JSON パース
      - 失敗 → PARSE_ERROR
  [5] 成功 → (gemini_data_dict, None)
```

#### `detect_content(image_b64, mode, request_id, context_hint) -> dict`

メインエントリポイント。画像解析を実行する。

```python
def detect_content(
    image_b64: str,       # Base64エンコード画像
    mode: str = "text",   # 検出モード（7種）
    request_id: str = "", # ログ追跡用ID
    context_hint: str = "",  # 追加コンテキスト
) -> dict
```

```
処理フロー:
  [1] APIキー未設定チェック → ValueError
  [2] モードバリデーション → ValueError
  [3] _ensure_jpeg() → JPEG統一変換
      - ValueError → 伝播
      - その他Exception → PARSE_ERROR
  [4] _build_gemini_payload() → ペイロード構築
  [5] _send_gemini_request() → API通信 + 429リトライ
  [6] _extract_gemini_content() → レスポンス解析
  [7] _dispatch_mode_handler() → モード別パーサー呼び出し
  例外ハンドリング:
    - Timeout → TIMEOUT
    - ConnectionError → CONNECTION_ERROR
    - RequestException → REQUEST_ERROR
```

#### `_dispatch_mode_handler(mode, gemini_data, image_b64) -> dict`

モードに応じたパーサーを呼び出し、統一された成功レスポンスを返す。

```python
_MODE_HANDLERS = {
    "text":     {"parser": _parse_gemini_text_response,     "needs_image_size": True},
    "object":   {"parser": _parse_gemini_object_response,   "needs_image_size": False},
    "label":    {"parser": _parse_gemini_label_response,    "needs_image_size": True},
    "face":     {"parser": _parse_gemini_face_response,     "needs_image_size": True},
    "logo":     {"parser": _parse_gemini_logo_response,     "needs_image_size": True},
    "classify": {"parser": _parse_gemini_classify_response, "needs_image_size": False},
    "web":      {"parser": _parse_gemini_web_response,      "needs_image_size": False},
}
```

### 3.7 モード別パーサー

#### `_parse_gemini_text_response(gemini_data, image_size) -> list`

| 入力キー | 出力フィールド |
|----------|-------------|
| `texts[].text` | `label`: テキスト内容 |
| `texts[].box_2d` | `bounds`: ピクセル座標4頂点 |

#### `_parse_gemini_object_response(gemini_data) -> list`

| 入力キー | 出力フィールド |
|----------|-------------|
| `objects[].name` + `name_ja` + `score` | `label`: `"Person（人）- 95%"` 形式 |
| `objects[].box_2d` | `bounds`: 正規化座標（0〜1）4頂点 |

#### `_parse_gemini_label_response(gemini_data, image_size) -> tuple`

```python
戻り値: (data_list, label_detected: bool, label_reason: str)
```

| 入力キー | 出力 |
|----------|------|
| `label_detected` | ラベル/テキスト有無のbool |
| `reason` | 判定理由（空の場合は自動生成） |
| `texts[]` | textモードと同形式のdata_list |

#### `_parse_gemini_face_response(gemini_data, image_size) -> list`

| 入力キー | 出力フィールド |
|----------|-------------|
| `faces[].box_2d` | `bounds`: ピクセル座標4頂点 |
| `faces[].confidence` | `confidence`: 検出確信度 |
| `faces[].joy/sorrow/anger/surprise` | `emotions`: 4感情辞書 |
| 組み合わせ | `label`: `"顔1: 喜び(非常に高い), 驚き(あり得る) - 95%"` |

感情ラベル生成ルール:
- `POSSIBLE`, `LIKELY`, `VERY_LIKELY` のみラベルに含める
- 該当なし → `"表情なし"`
- 感情名はEMOTION_NAMES辞書で日本語化、レベルはEMOTION_LIKELIHOOD辞書で日本語化

#### `_parse_gemini_logo_response(gemini_data, image_size) -> list`

| 入力キー | 出力フィールド |
|----------|-------------|
| `logos[].name` + `score` | `label`: `"Nike - 92%"` 形式 |
| `logos[].box_2d` | `bounds`: ピクセル座標4頂点 |

#### `_parse_gemini_classify_response(gemini_data) -> list`

| 入力キー | 出力フィールド |
|----------|-------------|
| `labels[].name` + `name_ja` + `score` | `label`: `"Laptop（ノートPC）- 85%"` 形式 |
| `labels[].score` | `score`: 確信度（0.0〜1.0） |

座標なし（画像全体の分類）。

#### `_parse_gemini_web_response(gemini_data) -> tuple`

```python
戻り値: (data_list, web_detail)
```

| 出力 | 内容 |
|------|------|
| `data_list` | `[{"label": "推定: ..."}, {"label": "名前 (85%)"}, {"label": "説明: ..."}]` |
| `web_detail` | `{"best_guess": str, "entities": list, "pages": [], "similar_images": []}` |

`pages`と`similar_images`はGemini APIの制約で常に空配列。

### 3.8 HTTPセッション設計

```python
session = requests.Session()
retry_strategy = Retry(
    total=3, connect=3,
    backoff_factor=0.5,
    status_forcelist=[500, 502, 503, 504],  # 429はリトライせず即座に返す
    allowed_methods=["POST"],
)
```

- モジュールレベルで1回だけ作成（コネクションプール共有）
- 429はRetryに含めず、独自のリトライロジックで処理
- SSL検証は`VERIFY_SSL`環境変数で制御

---

## 4. rate_limiter.py — レート制限モジュール

### 4.1 定数

| 定数名 | 型 | デフォルト値 | 説明 |
|--------|-----|-------------|------|
| `REDIS_URL` | str | `""` | Redis接続URL |
| `RATE_LIMIT_PER_MINUTE` | int | `20` | 分あたり上限 |
| `RATE_LIMIT_DAILY` | int | `1000` | 日次上限 |

### 4.2 RateLimiterBackend（Protocol）

```python
class RateLimiterBackend(Protocol):
    def try_consume(self, client_ip: str) -> Tuple[bool, str, Optional[str | int]]: ...
    def release(self, client_ip: str, request_id: str) -> None: ...
    def get_daily_count(self, client_ip: str) -> int: ...
```

構造的部分型（ダックタイピング）によるインターフェース定義。

### 4.3 RedisRateLimiter クラス

#### `__init__(self, client)`

Redisクライアントインスタンスを受け取る。

#### `try_consume(self, client_ip) -> tuple[bool, str, str|int|None]`

Luaスクリプト（`_LUA_CONSUME`）による原子操作で制限チェック＆予約を実行する。

| 戻り値 | 条件 |
|--------|------|
| `(False, "", request_id)` | 予約成功 |
| `(True, "1日あたりの...", None)` | 日次制限超過 |
| `(True, "リクエスト頻度が...", wait_seconds)` | 分制限超過 |

Luaスクリプト引数:
- KEYS: `[minute_key, daily_key]`
- ARGV: `[now, request_id, per_minute, daily_limit, daily_ttl]`

#### `release(self, client_ip, request_id) -> None`

Luaスクリプト（`_LUA_RELEASE`）で指定IDの予約のみを取り消す。

#### `get_daily_count(self, client_ip) -> int`

`GET rate:daily:{client_ip}:{today}` で日次カウントを取得する。

### 4.4 InMemoryRateLimiter クラス

#### `__init__(self)`

```python
self._rate_store = TTLCache(maxsize=10_000, ttl=90)   # 分単位
self._daily_store = TTLCache(maxsize=10_000, ttl=86400) # 日次
self._lock = Lock()  # スレッド排他制御
```

#### `try_consume(self, client_ip) -> tuple[bool, str, str|int|None]`

`threading.Lock()`で排他制御しながら制限チェック＆予約を実行する。

```
処理フロー（ロック内）:
  [1] _daily_store から日次データ取得
  [2] 日付が変わっていたらカウントリセット
  [3] daily_count >= DAILY_LIMIT → 日次制限超過
  [4] _rate_store からエントリ取得
  [5] 60秒以内のエントリのみフィルタ
  [6] len(recent) >= PER_MINUTE → 分制限超過（wait_seconds計算）
  [7] request_id 生成、エントリ追加、日次カウント+1
```

#### `release(self, client_ip, request_id) -> None`

ロック内でrequest_idが一致するエントリのみ除去し、日次カウントを-1する。

#### `get_daily_count(self, client_ip) -> int`

日付一致チェック付きで日次カウントを返す。

### 4.5 公開API関数

| 関数 | 説明 |
|------|------|
| `try_consume_request(client_ip)` | レート制限チェック＆予約 |
| `release_request(client_ip, request_id)` | 指定IDの予約取り消し |
| `get_daily_count(client_ip)` | 日次カウント取得 |
| `get_backend_type()` | バックエンド種別を返す（`"redis"` or `"in_memory"`） |
| `reset_for_testing()` | テスト用: インメモリにリセット |

### 4.6 バックエンド選択（_get_backend）

遅延初期化パターンで最初の呼び出し時にバックエンドを決定する。

```
_get_backend():
  _backend が初期化済み → そのまま返す
  REDIS_URL 設定あり:
    Redis接続試行 → 成功 → RedisRateLimiter
                   → 失敗 → InMemoryRateLimiter（警告ログ）
  REDIS_URL 未設定 → InMemoryRateLimiter
```

---

## 5. translations.py — 翻訳辞書モジュール

### 5.1 辞書一覧

| 辞書名 | エントリ数 | 用途 |
|--------|---------|------|
| `OBJECT_TRANSLATIONS` | 約120件 | 物体検出の英語名→日本語名変換 |
| `EMOTION_LIKELIHOOD` | 5件 | 感情レベルの日本語化 |
| `EMOTION_NAMES` | 4件 | 感情名の日本語化 |
| `LABEL_TRANSLATIONS` | 約140件 | 分類タグの翻訳（OBJECT_TRANSLATIONS + 追加ラベル） |

### 5.2 OBJECT_TRANSLATIONS カテゴリ

| カテゴリ | 例 |
|---------|-----|
| 人物・身体 | person→人, face→顔, hand→手 |
| 衣類 | shirt→シャツ, glasses→メガネ |
| 家具・室内 | table→テーブル, chair→椅子 |
| 電子機器 | laptop→ノートPC, smartphone→スマホ |
| 食べ物・飲み物 | food→食べ物, bottle→ボトル |
| 乗り物 | car→車, bicycle→自転車 |
| 動物 | dog→犬, cat→猫 |
| 自然 | tree→木, sky→空 |
| 産業・工場 | equipment→機器, circuit board→基板 |
| 複合語 | bicycle wheel→自転車の車輪, traffic light→信号機 |

---

## 6. static/script.js — フロントエンドロジック

### 6.1 定数

| 定数名 | 値 | 説明 |
|--------|-----|------|
| `API_WARNING_RATIO` | `0.8` | API上限の警告表示閾値（80%で黄色） |
| `STABILITY_THRESHOLD` | `20` | 安定判定フレーム数 |
| `MOTION_THRESHOLD` | `30` | フレーム間差分の閾値 |
| `CAMERA_WIDTH` | `1280` | カメラ解像度（幅） |
| `CAMERA_HEIGHT` | `720` | カメラ解像度（高さ） |
| `JPEG_QUALITY` | `0.95` | キャプチャ画質 |
| `MIN_RESULT_LENGTH` | `5` | 結果フィルター最小文字数 |
| `LABEL_MAX_LENGTH` | `25` | バウンディングボックスのラベル最大文字数 |
| `RETRY_DELAY_MS` | `10000` | エラー後の再試行待機時間 |
| `FETCH_TIMEOUT_MS` | `60000` | fetchタイムアウト |
| `IMAGE_HASH_SIZE` | `8` | ハッシュ用縮小画像サイズ（8×8） |
| `IMAGE_HASH_THRESHOLD` | `0.95` | 画像ハッシュ類似度閾値（95%） |

### 6.2 モード別画像設定（MODE_IMAGE_CONFIG）

| モード | JPEG品質 | 最大幅 |
|--------|---------|--------|
| `text` | 0.95 | 1920 |
| `object` | 0.85 | 1280 |
| `label` | 0.95 | 1920 |
| `face` | 0.90 | 1600 |
| `logo` | 0.90 | 1600 |
| `classify` | 0.80 | 1024 |
| `web` | 0.85 | 1280 |

### 6.3 モード別ヒントplaceholder（MODE_HINT_PLACEHOLDER）

| モード | プレースホルダー例 |
|--------|----------------|
| `text` | `"言語やフォントのヒント（例: 手書き日本語）"` |
| `object` | `"探したい物のヒント（例: 電子部品）"` |
| `label` | `"ラベルの種類（例: 製品ラベル）"` |
| `face` | `"人物や状況のヒント（例: 集合写真）"` |
| `logo` | `"ブランド名のヒント（例: 自動車メーカー）"` |
| `classify` | `"分類の方向性（例: 料理のジャンル）"` |
| `web` | `"識別のヒント（例: 建築物、アート作品）"` |

### 6.4 主要関数一覧

#### ネットワーク・API通信

| 関数名 | 説明 |
|--------|------|
| `getNetworkQualityMultiplier()` | Network Information APIでネットワーク品質に応じた倍率を返す |
| `fetchSignal(ms)` | AbortControllerでタイムアウト付きシグナルを生成する |
| `fetchWithRetry(url, options, maxRetries, baseDelay)` | 指数バックオフ付きリトライ。429はretry_afterを尊重 |

#### API使用量管理

| 関数名 | 説明 |
|--------|------|
| `loadApiUsage()` | localStorageからAPI使用量をロードする |
| `saveApiUsage()` | localStorageにAPI使用量を保存する |
| `syncApiUsage()` | `/api/config/usage`でサーバー実値と同期する |
| `updateApiCounter()` | ヘッダーのAPI使用量表示を更新する（80%で黄色、100%で赤色） |
| `isApiLimitReached()` | 日次制限に達しているか判定する |
| `loadRateLimits()` | `/api/config/limits`から日次上限を取得する |

#### カメラ制御

| 関数名 | 説明 |
|--------|------|
| `setupCamera(deviceId)` | getUserMediaでカメラストリームを取得する |
| `stopCameraStream()` | カメラストリームを停止する |
| `populateCameraSelector()` | 利用可能なカメラデバイスをドロップダウンに列挙する |
| `switchCameraDevice(deviceId)` | 指定デバイスIDのカメラに切り替える |
| `toggleFacingMode()` | インカメ/外カメを切り替える。`isMirrored`を自動調整 |
| `updateFlipButton()` | 外カメ/インカメ切替ボタンのテキストを更新する |
| `updateFlipButtonVisibility()` | 複数カメラ時のみボタンを表示する |

#### スキャン制御

| 関数名 | 説明 |
|--------|------|
| `toggleScanning()` | スキャン開始/停止を切り替える |
| `startScanning()` | 連続スキャンを開始する |
| `stopScanning()` | スキャンを停止し、UIをリセットする |
| `scanLoop()` | requestAnimationFrameでフレーム処理ループを実行する |
| `checkStabilityAndCapture()` | フレーム差分で安定化を検出し、閾値達成でキャプチャ実行する |

#### 安定化検出の処理フロー

```
scanLoop() → requestAnimationFrame ループ
  ├── isScanning=false or waitingForResponse=true → スキップ
  └── checkStabilityAndCapture()
        [1] 64×48px キャンバスにフレーム縮小描画
        [2] 前フレームのピクセルデータと差分計算
        [3] diff < MOTION_THRESHOLD(30)
        │     └── stableFrameCount++
        │           └── >= STABILITY_THRESHOLD(20) → captureAndAnalyze()
        └── diff >= MOTION_THRESHOLD
              └── stableFrameCount = 0, resetDuplicateState()
```

#### キャプチャ・解析

| 関数名 | 説明 |
|--------|------|
| `captureAndAnalyze()` | フレームをキャプチャしてAPI送信、結果描画する |

```
captureAndAnalyze() 処理フロー:
  [1] waitingForResponse = true
  [2] モード別画像設定取得（品質・最大幅）
  [3] canvas.toDataURL() でBase64キャプチャ
  [4] computeImageHash() で前回画像と比較
      → 類似度 >= 95% → APIスキップ（前回結果を再利用）
  [5] fetchWithRetry('/api/analyze', {image, mode, hint})
  [6] レスポンス処理:
      - 429: startCooldownCountdown(retry_after)
      - ok=true: モード別結果描画
      - ok=false: エラー表示
  [7] computeResultFingerprint() で重複検出
      → 連続一致 >= DUPLICATE_SKIP_COUNT → 一時停止
  [8] waitingForResponse = false
  [9] catch: isScanning時は scheduleRetry() で自動復帰
```

#### 重複検出

| 関数名 | 説明 |
|--------|------|
| `computeResultFingerprint(result)` | 結果データのフィンガープリントを計算する |
| `computeImageHash(srcCanvas)` | 8×8グレースケールハッシュを計算する |
| `compareImageHash(hashA, hashB)` | 2つのハッシュの類似度（0〜1）を計算する |

`computeResultFingerprint`のロジック:
```javascript
result.data
  .map(item => item.label.trim()
    .replace(/\s*[-–]\s*\d+%\s*$/, '')  // 確信度パーセント除去
    .toLowerCase())                       // 大文字小文字正規化
  .filter(label => label.length >= MIN_RESULT_LENGTH)
  .sort()
  .join('|')
```

#### クールダウン・リトライ

| 関数名 | 説明 |
|--------|------|
| `scheduleRetry()` | RETRY_DELAY_MS（10秒）後にスキャン再開する |
| `startCooldownCountdown(seconds)` | 429受信時のカウントダウンUI表示 |
| `stopCooldownCountdown()` | カウントダウンを中止する |

#### 結果描画

| 関数名 | 対応モード | 説明 |
|--------|----------|------|
| `drawBoundingBoxes(data, imageSize)` | text/object/face/logo/label | Canvas上にバウンディングボックスを描画する |
| `addResultItem(item)` | text/object/logo | 結果パネルに1件追加する |
| `addLabelResult(detected, reason)` | label | ラベル検出結果（detected/reason）を表示する |
| `addFaceResult(item)` | face | 顔検出結果（感情分析付き）を表示する |
| `addClassifyResult(items)` | classify | 分類タグ一覧を表示する |
| `addWebResult(webDetail, data)` | web | AI識別結果を表示する |
| `clearOverlay()` | 全モード | Canvasオーバーレイをクリアする |
| `clearResults()` | 全モード | 結果パネルをクリアする |

#### UI制御

| 関数名 | 説明 |
|--------|------|
| `setMode(mode)` | 解析モードを切り替える。ヒントplaceholderも更新 |
| `updateMirrorState()` | ミラー表示状態をVideoとCanvasに反映する |
| `toggleMirror()` | ミラーモードのON/OFFを切り替える |
| `switchSource(source)` | 入力ソース（camera/file）を切り替える |
| `handleFileUpload(event)` | ファイルアップロードを処理する（動画/静止画判別） |
| `disableScanButton(message)` | スキャンボタンを無効化する |
| `loadProxyConfig()` | プロキシ設定状態を取得して表示する |
| `updateProxyButton(isEnabled)` | Proxy ON/OFFバッジを更新する |
| `updateDupSkipBadge()` | 重複スキップ回数バッジを更新する |

#### 初期化

```
init() 処理フロー:
  [1] loadApiUsage() → localStorage から使用量ロード
  [2] loadRateLimits() → サーバーから上限値取得
  [3] syncApiUsage() → サーバー実値と同期
  [4] loadProxyConfig() → プロキシ状態取得
  [5] setupCamera() → カメラ起動
  [6] populateCameraSelector() → カメラ選択肢作成
  [7] イベントリスナー登録（ボタン・スライダー・ファイル入力）
  [8] DUPLICATE_SKIP_COUNT を localStorage から復元
  [9] updateDupSkipBadge() → バッジ表示
```

### 6.5 モード別バウンディングボックス設定（MODE_BOX_CONFIG）

| モード | 色 | 線幅 | フォントサイズ |
|--------|-----|------|-------------|
| `text` | `#4FC3F7` | 2 | 14 |
| `object` | `#81C784` | 3 | 16 |
| `label` | `#FFB74D` | 2 | 14 |
| `face` | `#F48FB1` | 3 | 16 |
| `logo` | `#CE93D8` | 3 | 16 |

### 6.6 状態変数

| 変数名 | 型 | 説明 |
|--------|-----|------|
| `isScanning` | bool | 連続スキャン中か |
| `isSingleShot` | bool | シングルショットモードか |
| `waitingForResponse` | bool | API応答待ちか |
| `currentMode` | string | 現在の解析モード |
| `isMirrored` | bool | ミラー表示中か |
| `currentFacingMode` | string | `"environment"` or `"user"` |
| `stableFrameCount` | int | 安定フレームの連続数 |
| `apiCallCount` | int | 今日のAPI呼び出し回数 |
| `dailyLimit` | int | 日次制限値 |
| `lastResultFingerprint` | string | 前回結果のフィンガープリント |
| `consecutiveDuplicates` | int | 連続重複カウント |
| `lastImageHash` | array | 前回画像の8×8ハッシュ |
| `DUPLICATE_SKIP_COUNT` | int | 重複スキップ閾値（1〜5、localStorage永続化） |

---

## 7. テスト設計

### 7.1 テストファイル構成

| ファイル | テスト対象 | テスト種別 |
|---------|----------|----------|
| `tests/conftest.py` | 共通フィクスチャ | - |
| `tests/test_api.py` | app.pyエンドポイント | 統合テスト |
| `tests/test_gemini_api.py` | gemini_api.py関数 | 単体テスト |
| `tests/e2e/` | ブラウザ操作 | E2Eテスト（Playwright） |

### 7.2 共有フィクスチャ（conftest.py）

| フィクスチャ/関数 | 説明 |
|------------|------|
| `client` | Flaskテストクライアント。テスト間でレート制限をリセット |
| `create_valid_image_base64()` | 最小限の有効なJPEG画像（1×1px）のBase64文字列 |
| `create_valid_png_base64()` | PIL生成PNG画像（2×2px）のBase64文字列 |
| `make_b64(data=None)` | テスト用Base64文字列生成（引数なしで有効JPEG） |
| `make_mock_response(status_code, json_data, content_type)` | requests.Responseのモック |

### 7.3 テスト実行コマンド

```bash
# 全テスト（E2E除外）
python -m pytest tests/ -q -m "not e2e"

# Flask API統合テストのみ
python -m pytest tests/test_api.py -q

# Gemini API単体テストのみ
python -m pytest tests/test_gemini_api.py -q

# 単一テスト実行
python -m pytest tests/test_api.py::TestAnalyzeEndpoint::test_missing_image -v
```

### 7.4 テストカバレッジ対象

#### test_api.py（統合テスト）

| テストクラス | テスト対象 |
|------------|----------|
| ヘルスチェック | `/healthz`, `/readyz` のレスポンス検証 |
| バリデーション | JSON形式、imageフィールド、mode、Base64、画像サイズ、フォーマット |
| レート制限 | 分制限超過、日次制限超過、429レスポンス形式 |
| 解析エンドポイント | 正常系（各モード）、エラー系（タイムアウト、接続エラー） |
| 管理API | プロキシ設定取得/更新、認証チェック |
| CORSプリフライト | OPTIONS レスポンス |

#### test_gemini_api.py（単体テスト）

| テストクラス | テスト対象 |
|------------|----------|
| _ensure_jpeg | PNG→JPEG変換、コントラスト強調、サイズ超過エラー |
| _build_gemini_payload | ペイロード構造、thinkingConfig、context_hint |
| _send_gemini_request | 成功、429リトライ、タイムアウト |
| _extract_gemini_content | candidates解析、SAFETY停止、JSONパース失敗 |
| モード別パーサー | 各7モードのレスポンスパース |
| 座標変換 | box_2d→ピクセル、box_2d→正規化、反転修正 |
| Thinking戦略 | 各モデルの設定検証、未知モデル警告 |

---

## 8. 処理シーケンス図

### 8.1 正常系（POST /api/analyze）

```
Client                  app.py               gemini_api.py          rate_limiter.py
  |                       |                       |                       |
  |-- POST /api/analyze ->|                       |                       |
  |                       |-- set_request_context()|                      |
  |                       |-- _validate_analyze_request()                 |
  |                       |                       |                       |
  |                       |-- _build_rate_key() --|                       |
  |                       |-- try_consume_request()|----- try_consume() ->|
  |                       |                       |                       |
  |                       |-- detect_content() -->|                       |
  |                       |                       |-- _ensure_jpeg()      |
  |                       |                       |-- _build_gemini_payload()
  |                       |                       |-- _send_gemini_request()
  |                       |                       |     |-- POST Gemini API
  |                       |                       |     |<-- 200 JSON
  |                       |                       |-- _extract_gemini_content()
  |                       |                       |-- _dispatch_mode_handler()
  |                       |                       |<-- result dict
  |                       |                       |                       |
  |<-- 200 JSON ----------|                       |                       |
  |                       |-- add_security_headers()                      |
```

### 8.2 API失敗時（ロールバック）

```
Client                  app.py               gemini_api.py          rate_limiter.py
  |                       |                       |                       |
  |-- POST /api/analyze ->|                       |                       |
  |                       |-- try_consume_request()|----- try_consume() ->|
  |                       |                       |   (カウント+1, request_id発行)
  |                       |-- detect_content() -->|                       |
  |                       |                       |-- Gemini API → 失敗   |
  |                       |                       |<-- error dict          |
  |                       |                       |                       |
  |                       |-- release_request() --|---- release() ------->|
  |                       |                       |   (request_idのカウントのみ-1)
  |<-- 502 JSON ----------|                       |                       |
```

### 8.3 フロントエンド連続スキャン

```
scanLoop() ─── requestAnimationFrame ──┐
    |                                   |
    ├── checkStabilityAndCapture()      |
    │     ├── フレーム差分計算           |
    │     ├── stableFrameCount++        |
    │     └── >= 20 ──────────────────┐ |
    │                                  | |
    │   captureAndAnalyze()  <─────────┘ |
    │     ├── imageHash比較              |
    │     │     └── 95%一致 → スキップ   |
    │     ├── fetchWithRetry()           |
    │     │     ├── 200 → 結果描画       |
    │     │     ├── 429 → cooldown       |
    │     │     └── error → scheduleRetry|
    │     └── fingerprint重複チェック    |
    │           └── N回連続 → 一時停止   |
    │                                    |
    └── 次フレーム ──────────────────────┘
```
