# 要件定義書

**プロジェクト名**: Gemini Vision Scanner
**バージョン**: 2.0.0
**作成日**: 2026-02-24

---

## 1. プロジェクト概要

### 1.1 目的

Google Gemini API を利用して、Webカメラまたはアップロード画像からリアルタイムに7種類の画像解析（OCR・物体検出・ラベル検出・顔検出・ロゴ検出・分類タグ・AI識別）を行うWebアプリケーションを提供する。

### 1.2 スコープ

- Flask（Python）製バックエンドによる Gemini API 連携
- Vanilla JavaScript（フレームワーク不使用）製フロントエンドによるカメラ制御・結果表示
- 2段階レート制限（分単位・日次）によるAPI消費管理
- Ubuntu + nginx + gunicorn、および Render クラウドの2系統デプロイ対応

### 1.3 対象ユーザー

| ユーザー種別 | 説明 |
|---|---|
| 一般ユーザー | Webカメラや画像ファイルから画像解析を行う利用者 |
| 管理者 | ADMIN_SECRET を保有し、プロキシ設定などを管理する運用担当者 |
| 開発者 | ソースコードを参照・修正する技術担当者 |

### 1.4 前提条件

- Google Gemini API キー（`GEMINI_API_KEY`）が必須
- Python 3.12.0 以上の実行環境
- デフォルトモデルは `gemini-2.5-flash`
- カメラ機能は HTTPS 接続が必須（ブラウザのセキュリティポリシー）

---

## 2. 機能要件

### 2.1 画像入力機能

| 機能ID | 機能名 | 説明 |
|---|---|---|
| F-001 | Webカメラ入力 | `getUserMedia` API で HD映像（1280×720）を取得する |
| F-002 | 複数カメラ選択 | 2台以上のカメラ接続時にドロップダウンで切り替える |
| F-003 | インカメ/外カメ切替 | `facingMode` を切り替える。インカメ時は自動でミラーON |
| F-004 | ファイルアップロード | `video/*,image/*` 形式のファイルをアップロードして解析する |
| F-005 | 静止画解析 | `<img>` 要素に表示した静止画をキャプチャして解析する |
| F-006 | 左右反転 | ミラーモードのON/OFF切替。バウンディングボックスのX座標も同期反転 |

### 2.2 解析モード機能（7種）

各モードは Gemini API の専用プロンプトおよび JSON Schema を使用する。

| 機能ID | モード | 処理内容 | 出力形式 |
|---|---|---|---|
| F-010 | text（テキスト抽出） | OCRでテキストブロックを抽出 | `{label, bounds}` ピクセル座標 |
| F-011 | object（物体検出） | 最大10物体を検出、英語名・日本語名・スコア付き | `{label, bounds}` 正規化座標(0〜1) |
| F-012 | label（ラベル検出） | ラベル/バーコード/QRコードの有無を判定 | `{label_detected, label_reason, data}` |
| F-013 | face（顔検出） | 顔を検出しjoy/sorrow/anger/surpriseの4感情を分析 | `{label, bounds, emotions, confidence}` |
| F-014 | logo（ロゴ検出） | ブランドロゴを検出、名前とスコア付き | `{label, bounds}` |
| F-015 | classify（分類タグ） | 画像全体に対する分類ラベルを最大10個推定 | `{label, score}` |
| F-016 | web（AI識別） | 物・場所・作品を識別 | `{best_guess, entities, pages, similar_images}` |

### 2.3 スキャン制御機能

| 機能ID | 機能名 | 説明 |
|---|---|---|
| F-020 | シングルショット解析 | 「スタート」ボタン押下で1回キャプチャ→解析。完了でボタンをリセット |
| F-021 | 安定化検出 | 64×48pxの縮小キャンバスで毎フレーム差分を計算。閾値(30)以下が20フレーム連続したらキャプチャ実行 |
| F-022 | 安定化バー表示 | 安定化進捗を0〜100%のプログレスバーで可視化 |
| F-023 | キーワードヒント入力 | 追加コンテキストを入力可能（最大200文字、制御文字除去）。モード別にplaceholderを切替 |
| F-024 | 重複検出・一時停止 | `computeResultFingerprint()` で判定。設定回数連続一致で一時停止。カメラ移動で自動再開 |
| F-025 | 画像ハッシュ比較 | 8×8グレースケールハッシュで前回送信画像と比較。類似度≥95%でAPIスキップ |
| F-026 | 重複スキップ回数設定 | スライダー(1〜5回)で変更可能。`localStorage`に保存 |

### 2.4 レート制限機能

| 機能ID | 機能名 | 説明 |
|---|---|---|
| F-030 | 分単位レート制限 | デフォルト20回/分。超過時は`Retry-After`ヘッダーと`retry_after`フィールドで待機秒数を返す |
| F-031 | 日次レート制限 | デフォルト1000回/日。超過時はスキャンボタンを永続無効化 |
| F-032 | クールダウンUI | 429(分制限)受信時、Retry-Afterの秒数でカウントダウン表示 |
| F-033 | API使用量表示 | ヘッダーに`API: 使用数/上限数`を表示。80%で黄色、100%で赤色 |
| F-034 | サーバー側使用量同期 | 起動時に`/api/config/usage`を呼び出し、`localStorage`のカウントをサーバー実値で補正 |
| F-035 | レート制限キー設定 | `RATE_LIMIT_KEY_MODE`環境変数で`ip_ua`(IP+UserAgent複合)または`ip`(IPのみ)を選択 |

### 2.5 プロキシ制御機能

| 機能ID | 機能名 | 説明 |
|---|---|---|
| F-040 | プロキシ状態表示 | ヘッダーに「Proxy設定: ON/OFF」バッジを表示 |
| F-041 | プロキシ有効/無効切替 | `POST /api/config/proxy`に`{enabled: bool}`を送信（`X-Admin-Secret`ヘッダー必須） |
| F-042 | URL認証情報マスク | `_mask_proxy_url()`でログ・APIレスポンス中の認証情報を`***:***`に置換 |

### 2.6 ヘルスチェック機能

| 機能ID | エンドポイント | 説明 |
|---|---|---|
| F-050 | GET /healthz | Livenessチェック。依存なしで常に`{"status": "ok"}`を返す |
| F-051 | GET /readyz | Readinessチェック。APIキー設定・レート制限バックエンドの正常性を確認 |

---

## 3. 非機能要件

### 3.1 パフォーマンス要件

| 項目 | 要件値 | コード参照 |
|---|---|---|
| Gemini APIタイムアウト | 30秒 | `gemini_api.py: API_TIMEOUT_SECONDS = 30` |
| フロントfetchタイムアウト | 60秒 | `script.js: FETCH_TIMEOUT_MS = 60000` |
| 安定化フレーム数 | 20フレーム | `script.js: STABILITY_THRESHOLD = 20` |
| 最大リクエストボディ | 10MB | `app.py: MAX_REQUEST_BODY` |
| 最大デコード後画像 | 5MB | `app.py: MAX_IMAGE_SIZE` |
| 429リトライ回数 | 2回(デフォルト) | `gemini_api.py: GEMINI_429_MAX_RETRIES` |
| フロントfetchリトライ | 3回 | `script.js: maxRetries = 3` |
| エラー後再試行待機 | 10秒 | `script.js: RETRY_DELAY_MS = 10000` |

### 3.2 セキュリティ要件

| 項目 | 要件 |
|---|---|
| 画像フォーマット検証 | マジックバイトでJPEG/PNGのみ許可 |
| CSPヘッダー | nonce化により`unsafe-inline`を完全排除 |
| CORS | `ALLOWED_ORIGINS`環境変数で明示的に許可したOriginのみ |
| 管理API認証 | `secrets.compare_digest()`による定時間比較認証 |
| APIキー管理 | 環境変数(`.env`)経由。ハードコード禁止 |
| XSS対策 | `innerHTML`不使用。DOM API(`createElement`・`createTextNode`)でテキスト挿入 |

### 3.3 可用性要件

| 項目 | 要件 |
|---|---|
| systemd自動再起動 | `Restart=on-failure`、`RestartSec=5` |
| Redisフォールバック | Redis接続失敗時はインメモリバックエンドに自動切替 |
| フロントエンドリトライ | ネットワークエラー時に指数バックオフで最大3回自動リトライ |
| エラー後スキャン再開 | 連続スキャン中のエラーは`scheduleRetry()`で10秒後に自動復帰 |

### 3.4 レスポンシブ対応

| ブレークポイント | 対応内容 |
|---|---|
| 768px以下 | モバイル向けレイアウト（単一カラム）、タッチターゲット拡大 |
| 480px以下 | コンパクトUI（ボタン・フォントサイズ縮小） |
| ダークモード | Material Design 3 ダークテーマを標準適用 |

---

## 4. 制約事項

| 区分 | 制約内容 |
|---|---|
| 画像フォーマット | JPEG・PNGのみ対応。GIF・WebP・BMPは拒否 |
| API依存 | webモードでは実際のWeb検索は不可。`pages`・`similar_images`は常に空配列 |
| カメラ機能 | HTTPS（またはlocalhost）環境でのみ動作 |
| マルチプロセス | gunicornマルチワーカー構成ではRedisバックエンドが必須 |
| SSL | Ubuntuデプロイでは自己署名証明書を使用。本番では正規証明書を推奨 |

---

## 5. 環境変数一覧

| 変数 | デフォルト | 説明 |
|------|---------|------|
| `GEMINI_API_KEY` | 必須 | Google Gemini APIキー |
| `GEMINI_MODEL` | gemini-2.5-flash | 使用モデル |
| `GEMINI_429_MAX_RETRIES` | 2 | 429リトライ回数 |
| `GEMINI_429_BACKOFF_BASE_SECONDS` | 1.5 | バックオフ基準秒 |
| `PROXY_URL` | 空 | HTTPプロキシ |
| `NO_PROXY_MODE` | false | プロキシ無視モード |
| `REDIS_URL` | 空 | Redis接続URL |
| `RATE_LIMIT_PER_MINUTE` | 20 | 分あたりリクエスト上限 |
| `RATE_LIMIT_DAILY` | 1000 | 日次リクエスト上限 |
| `RATE_LIMIT_KEY_MODE` | ip_ua | レート制限キー方式 |
| `ALLOWED_ORIGINS` | 空 | CORS許可Origin（カンマ区切り） |
| `ADMIN_SECRET` | 空 | 管理API認証用シークレット |
| `APP_PORT` | 5000 | アプリポート |
| `FLASK_DEBUG` | false | デバッグモード |
| `TRUST_PROXY` | false | リバースプロキシ信頼 |
